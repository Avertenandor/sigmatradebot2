# –ê—É–¥–∏—Ç –±–∞—Ç—á–∏–Ω–≥–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2025-01-16  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ  
**–í–µ—Ä—Å–∏—è:** 1.0

---

## –¶–µ–ª—å –∞—É–¥–∏—Ç–∞

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∞—Ç—á–∏–Ω–≥ –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ RPC-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—ë—Ä–Ω—É—Ç—ã –≤ `RPCRateLimiter`.

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

### ‚úÖ –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

#### 1. `jobs/tasks/deposit_monitoring.py` ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `BlockchainService.check_transaction_status()`

**–ö–æ–¥:**
```python
blockchain_service = get_blockchain_service()
tx_status = await blockchain_service.check_transaction_status(deposit.tx_hash)
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `get_blockchain_service()` (–Ω–µ –ø—Ä—è–º–æ–π Web3)
- ‚úÖ `check_transaction_status()` –æ–±—ë—Ä–Ω—É—Ç –≤ `RPCRateLimiter`
- ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π –¥–µ–ø–æ–∑–∏—Ç –æ—Ç–¥–µ–ª—å–Ω–æ (N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è N –¥–µ–ø–æ–∑–∏—Ç–æ–≤)

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ö–∞–∂–¥—ã–π –¥–µ–ø–æ–∑–∏—Ç –∏–º–µ–µ—Ç —Å–≤–æ–π `tx_hash`, –ø–æ—ç—Ç–æ–º—É –±–∞—Ç—á–∏–Ω–≥ –∑–¥–µ—Å—å –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ `RPCRateLimiter`, —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤

#### 2. `BlockchainService.monitor_incoming_deposits()` ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç event filter –¥–ª—è –±–∞—Ç—á–µ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

**–ö–æ–¥:**
```python
async def monitor_incoming_deposits(
    self,
    watch_address: str,
    from_block: int,
    to_block: int | None = None,
) -> list[dict]:
    # –°–æ–∑–¥–∞—ë—Ç event filter
    event_filter = self.usdt_contract.events.Transfer.create_filter(
        fromBlock=from_block,
        toBlock=to_block,
        argument_filters={"to": watch_address_checksum}
    )
    
    # –ë–∞—Ç—á–µ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
    events = event_filter.get_all_entries()
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç event filter (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π)
- ‚úÖ –ë–∞—Ç—á–µ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ `get_all_entries()`
- ‚úÖ –û–±—ë—Ä–Ω—É—Ç–æ –≤ `RPCRateLimiter`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è N —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚Üí 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —ç–∫–æ–Ω–æ–º–∏—Ç RPC-–∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ –Ω–æ–≤—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤

---

## –í—ã–≤–æ–¥—ã

### ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–æ–≤—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç event filter (–±–∞—Ç—á–∏–Ω–≥) ‚úÖ
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `check_transaction_status()` —Å `RPCRateLimiter` ‚úÖ
3. **–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—ë—Ä–Ω—É—Ç—ã:** –í `RPCRateLimiter` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ª–∏–º–∏—Ç–æ–≤ ‚úÖ

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RPC

**–¢–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–æ–≤—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤: 1 –∑–∞–ø—Ä–æ—Å/–º–∏–Ω—É—Ç—É (event filter)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ pending: N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è N pending –¥–µ–ø–æ–∑–∏—Ç–æ–≤ (–Ω–æ —á–µ—Ä–µ–∑ –ª–∏–º–∏—Ç–µ—Ä)

**–û—Ü–µ–Ω–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏:**
- –ü—Ä–∏ 10 pending –¥–µ–ø–æ–∑–∏—Ç–∞—Ö: ~10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- –ü—Ä–∏ 100 pending –¥–µ–ø–æ–∑–∏—Ç–∞—Ö: ~100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É (–Ω–æ –ª–∏–º–∏—Ç–µ—Ä –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ 25 RPS)

**–í—ã–≤–æ–¥:** –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞.

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞

**–ü—Ä–∏—á–∏–Ω–∞:**
- Event filter —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–æ–≤—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–µ–ª—å–∑—è –±–∞—Ç—á–∏—Ç—å)
- `RPCRateLimiter` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤

### üìù –î–ª—è –±—É–¥—É—â–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

**–ï—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –≤—ã—Ä–∞—Å—Ç–µ—Ç:**
1. –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ pending –¥–µ–ø–æ–∑–∏—Ç–æ–≤ (—Å 1 –º–∏–Ω—É—Ç—ã –¥–æ 2-3 –º–∏–Ω—É—Ç)
2. –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ WebSocket –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `app/services/blockchain_service.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
- `jobs/tasks/deposit_monitoring.py` - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- `app/services/blockchain/rpc_rate_limiter.py` - RPCRateLimiter
- `docs/monitoring/RPC_LIMITS.md` - –ª–∏–º–∏—Ç—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

**–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞:** 2025-01-16  
**–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤

