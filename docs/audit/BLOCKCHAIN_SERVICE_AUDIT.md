# –ê—É–¥–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è BlockchainService

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2025-01-16  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–π–¥–µ–Ω  
**–í–µ—Ä—Å–∏—è:** 1.0

---

## –¶–µ–ª—å –∞—É–¥–∏—Ç–∞

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ RPC-–≤—ã–∑–æ–≤—ã –∫ –±–ª–æ–∫—á–µ–π–Ω—É –∏–¥—É—Ç —á–µ—Ä–µ–∑ `BlockchainService` –∏ –æ–±—ë—Ä–Ω—É—Ç—ã –≤ `RPCRateLimiter`. –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Web3 –≤–Ω–µ `BlockchainService` –∑–∞–ø—Ä–µ—â–µ–Ω–æ.

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

### ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Web3 –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

–í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Web3 –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö:

#### 1. `app/services/blockchain_service.py` ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å - –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
- `Web3(Web3.HTTPProvider(rpc_url))` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
- `self.web3.eth.*` - –≤—Å–µ RPC-–≤—ã–∑–æ–≤—ã –æ–±—ë—Ä–Ω—É—Ç—ã –≤ `async with self.rpc_limiter`
- –í—Å–µ –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `RPCRateLimiter` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ª–∏–º–∏—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä:**
```python
async with self.rpc_limiter:
    block_number = await self._run_in_executor(
        self._executor, lambda: self.web3.eth.block_number
    )
```

#### 2. `app/services/blockchain/` ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ú–æ–¥—É–ª—å blockchain - –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–§–∞–π–ª—ã:**
- `provider_manager.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ (AsyncWeb3)
- `payment_sender.py` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç provider_manager)
- `deposit_processor.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç provider_manager)
- `event_monitor.py` - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç provider_manager)
- `blockchain_service.py` - –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ provider_manager

**–í—Å–µ —Ñ–∞–π–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `provider_manager.get_http_web3()` –∏–ª–∏ `provider_manager.get_ws_web3()`**, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `BlockchainService`.

#### 3. `app/services/deposit_service.py` ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ù–ï–¢ –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Web3

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ Web3, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.

#### 4. `app/services/withdrawal_service.py` ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ù–ï–¢ –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Web3

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ Web3, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.

#### 5. `jobs/tasks/deposit_monitoring.py` ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `get_blockchain_service()`

**–ö–æ–¥:**
```python
from app.services.blockchain_service import get_blockchain_service

blockchain_service = get_blockchain_service()
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ç–æ–¥—ã blockchain_service, –Ω–µ –ø—Ä—è–º–æ–π Web3
```

#### 6. `app/utils/health_check.py` ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `blockchain_service.web3` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è

**–ö–æ–¥:**
```python
lambda: blockchain_service.web3.eth.chain_id
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ, —Ç.–∫. —ç—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞, –∞ –Ω–µ –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏—è.

---

## –í—ã–≤–æ–¥—ã

### ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã

1. **–ù–µ—Ç –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Web3** –≤–Ω–µ `BlockchainService` –∏ –º–æ–¥—É–ª—è `blockchain/`
2. **–í—Å–µ RPC-–≤—ã–∑–æ–≤—ã –æ–±—ë—Ä–Ω—É—Ç—ã** –≤ `RPCRateLimiter` —á–µ—Ä–µ–∑ `async with self.rpc_limiter`
3. **–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç** `get_blockchain_service()` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–ª–æ–∫—á–µ–π–Ω—É
4. **–ú–æ–¥—É–ª—å `blockchain/`** –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å Web3

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–§–∞–π–ª–æ–≤ —Å Web3:** 6 (–≤—Å–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö)
- **–§–∞–π–ª–æ–≤ –±–µ–∑ Web3 (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞):** 2 (deposit_service, withdrawal_service)
- **–ü—Ä–æ–±–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:** ‚úÖ

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Web3 –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è:
- `BlockchainService` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å —Å `RPCRateLimiter`
- `blockchain/` - –º–æ–¥—É–ª—å –¥–ª—è –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ë–∏–∑–Ω–µ—Å-—Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `BlockchainService`, –Ω–µ –ø—Ä—è–º–æ–π Web3

### üìù –î–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–ü—Ä–∞–≤–∏–ª–æ:** –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º:
1. –ò—Å–ø–æ–ª—å–∑—É–π `get_blockchain_service()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
2. –í—ã–∑—ã–≤–∞–π –º–µ—Ç–æ–¥—ã `BlockchainService` (–æ–Ω–∏ —É–∂–µ –æ–±—ë—Ä–Ω—É—Ç—ã –≤ `RPCRateLimiter`)
3. **–ù–ï —Å–æ–∑–¥–∞–≤–∞–π** –Ω–æ–≤—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã `Web3()` –≤–Ω–µ `BlockchainService`

**–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from app.services.blockchain_service import get_blockchain_service

blockchain = get_blockchain_service()
balance = await blockchain.get_balance(address)  # –£–∂–µ –æ–±—ë—Ä–Ω—É—Ç–æ –≤ RPCRateLimiter
```

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `app/services/blockchain_service.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
- `app/services/blockchain/rpc_rate_limiter.py` - RPCRateLimiter
- `docs/monitoring/RPC_LIMITS.md` - –ª–∏–º–∏—Ç—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

**–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞:** 2025-01-16  
**–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:** –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞, —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º

