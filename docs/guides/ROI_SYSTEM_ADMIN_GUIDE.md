# ROI –°–∏—Å—Ç–µ–º–∞ - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

ROI (Return on Investment) —Å–∏—Å—Ç–µ–º–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–µ–ø–æ–∑–∏—Ç–æ–≤ —É—Ä–æ–≤–Ω—è 1 –¥–æ **500%** (5x).

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

### 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏

**–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞** ‚Üí **"‚öôÔ∏è –î–µ–ø–æ–∑–∏—Ç—ã"**

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫—Ä—ã—Ç —Ç–æ–ª—å–∫–æ **–£—Ä–æ–≤–µ–Ω—å 1 (10 USDT)**.

–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏:
- –£—Ä–æ–≤–µ–Ω—å 2 (50 USDT)
- –£—Ä–æ–≤–µ–Ω—å 3 (100 USDT)
- –£—Ä–æ–≤–µ–Ω—å 4 (500 USDT)
- –£—Ä–æ–≤–µ–Ω—å 5 (1000 USDT)

**–í–∞–∂–Ω–æ**: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

### 2. –ü—Ä–æ—Å–º–æ—Ç—Ä ROI —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞** ‚Üí **"‚öôÔ∏è –î–µ–ø–æ–∑–∏—Ç—ã"** ‚Üí **"üìä ROI –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"**

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
```
üìä ROI –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–£—Ä–æ–≤–µ–Ω—å 1)

–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
üîÑ –ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤: 15
‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤: 8
üí∞ –í—Å–µ–≥–æ –≤–Ω–µ—Å–µ–Ω–æ L1: 230.00 USDT
üí∏ –í—Å–µ–≥–æ –≤—ã–ø–ª–∞—á–µ–Ω–æ ROI: 187.50 USDT
üìà –°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: 62.3%

üî• –ë–ª–∏–∑–∫–∏ –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é (>80%):
1. User 123456789
   üìä 94.2% | ‚è≥ 2.90 USDT
2. User 987654321
   üìä 87.5% | ‚è≥ 6.25 USDT
```

## üìã –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –ü—Ä–∞–≤–∏–ª–∞ —Å–∏—Å—Ç–µ–º—ã

1. **–û–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π L1 –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
   - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –ë–î: `uq_active_level1_deposit_per_user`
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

2. **ROI Cap = 5x –¥–µ–ø–æ–∑–∏—Ç–∞**
   - –î–ª—è L1 (10 USDT): –º–∞–∫—Å–∏–º—É–º 50 USDT –¥–æ—Ö–æ–¥–∞
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –¥–µ–ø–æ–∑–∏—Ç–∞

3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞**
   - `roi_paid_amount` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –≤—ã–ø–ª–∞—Ç—ã
   - `is_roi_completed = true` –∫–æ–≥–¥–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç cap

4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ**
   - –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 500% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   - –î–∞–ª—å–Ω–µ–π—à–∏–µ reward sessions –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç –¥–æ—Ö–æ–¥

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ `deposits`

–ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏:
```sql
roi_cap_amount      DECIMAL(20,8)  -- –ú–∞–∫—Å–∏–º—É–º (5x –¥–ª—è L1)
roi_paid_amount     DECIMAL(20,8)  -- –£–∂–µ –≤—ã–ø–ª–∞—á–µ–Ω–æ
is_roi_completed    BOOLEAN        -- –§–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
roi_completed_at    TIMESTAMP      -- –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
```

–ò–Ω–¥–µ–∫—Å—ã:
```sql
-- –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π L1 –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE UNIQUE INDEX uq_active_level1_deposit_per_user
ON deposits(user_id)
WHERE level = 1 AND status = 'confirmed' AND is_roi_completed = false;

-- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö
CREATE INDEX idx_deposits_roi_completed
ON deposits(is_roi_completed);
```

### –¢–∞–±–ª–∏—Ü–∞ `system_settings`

```sql
key: 'DEPOSITS_MAX_OPEN_LEVEL'
value: '1'  -- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ L1
updated_at: TIMESTAMP
```

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞

```typescript
// DepositService.createPendingDeposit()
if (level === 1) {
  const activeL1 = await getActiveLevel1Cycle(userId);
  if (activeL1) {
    return { error: '–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç' };
  }
}
```

### 2. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞

```typescript
// DepositService.confirmDeposit()
if (deposit.level === 1) {
  deposit.roi_cap_amount = depositAmount * 5;
  deposit.roi_paid_amount = '0';
  deposit.is_roi_completed = false;
}
```

### 3. –†–∞—Å—á—ë—Ç –Ω–∞–≥—Ä–∞–¥

```typescript
// RewardService.calculateRewardsForSession()
if (deposit.level === 1 && deposit.roi_cap_amount) {
  if (deposit.is_roi_completed) {
    continue; // Skip this deposit
  }

  const remaining = roiCap - roiPaid;
  if (rewardAmount > remaining) {
    rewardAmount = remaining; // Cap to remaining
  }
}
```

### 4. –í—ã–ø–ª–∞—Ç–∞ –Ω–∞–≥—Ä–∞–¥

```typescript
// PaymentService.processUserRewardPayments()
// Update ROI progress
deposit.roi_paid_amount += rewardAmount;

if (deposit.roi_paid_amount >= deposit.roi_cap_amount) {
  deposit.is_roi_completed = true;
  deposit.roi_completed_at = new Date();

  // Send notification
  await notificationService.notifyRoiCompleted();
}
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

1. **–ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–∏–∫–ª—ã** (`totalActiveL1Deposits`)
   - –°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ–π—á–∞—Å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç

2. **–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã** (`totalCompletedL1Cycles`)
   - –°–∫–æ–ª—å–∫–æ —Ü–∏–∫–ª–æ–≤ —É–∂–µ –¥–æ—Å—Ç–∏–≥–ª–∏ 500%

3. **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å** (`averageRoiProgress`)
   - –í —Å—Ä–µ–¥–Ω–µ–º —Å–∫–æ–ª—å–∫–æ % ROI –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ

4. **–ë–ª–∏–∑–∫–∏–µ –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é** (`nearingCompletion`)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å >80% ROI

### SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ L1 –¥–µ–ø–æ–∑–∏—Ç—ã
SELECT
  COUNT(*) as active_deposits,
  AVG((CAST(roi_paid_amount AS DECIMAL) / CAST(roi_cap_amount AS DECIMAL)) * 100) as avg_progress
FROM deposits
WHERE level = 1
  AND status = 'confirmed'
  AND is_roi_completed = false
  AND roi_cap_amount IS NOT NULL;

-- –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã
SELECT COUNT(*) as completed_cycles
FROM deposits
WHERE level = 1
  AND is_roi_completed = true;

-- –ë–ª–∏–∑–∫–∏–µ –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é (>80%)
SELECT
  u.telegram_id,
  d.roi_paid_amount,
  d.roi_cap_amount,
  (CAST(d.roi_paid_amount AS DECIMAL) / CAST(d.roi_cap_amount AS DECIMAL) * 100) as progress_percent
FROM deposits d
JOIN users u ON d.user_id = u.id
WHERE d.level = 1
  AND d.is_roi_completed = false
  AND d.roi_cap_amount IS NOT NULL
  AND (CAST(d.roi_paid_amount AS DECIMAL) / CAST(d.roi_cap_amount AS DECIMAL)) > 0.8
ORDER BY progress_percent DESC;
```

## üö® –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ L1 –¥–µ–ø–æ–∑–∏—Ç–æ–≤
**–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ**: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –ë–î
```sql
ERROR: duplicate key value violates unique constraint
       "uq_active_level1_deposit_per_user"
```

### 2. ROI –ø—Ä–µ–≤—ã—à–∞–µ—Ç cap
**–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ `RewardService`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ `PaymentService`

### 3. –ö—ç—à –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É—Å—Ç–∞—Ä–µ–ª
**–†–µ—à–µ–Ω–∏–µ**: TTL 60 —Å–µ–∫—É–Ω–¥, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞–∫—Å. –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è

```typescript
// –ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
await settingsService.setMaxOpenLevel(3); // –û—Ç–∫—Ä—ã—Ç—å L1-L3

// –ù–∞–ø—Ä—è–º—É—é –≤ –ë–î (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
UPDATE system_settings
SET value = '3', updated_at = NOW()
WHERE key = 'DEPOSITS_MAX_OPEN_LEVEL';
```

### –†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è ROI

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
SELECT
  id,
  user_id,
  amount,
  roi_cap_amount,
  roi_paid_amount,
  is_roi_completed
FROM deposits
WHERE level = 1 AND user_id = <user_id>;

-- –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ROI (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
UPDATE deposits
SET
  roi_paid_amount = '45.50',
  is_roi_completed = false
WHERE id = <deposit_id>;
```

## üìà –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:
- [ ] ROI —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π 2-5
- [ ] –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç ROI (–Ω–µ —Ç–æ–ª—å–∫–æ 500%)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±–æ–Ω—É—Å—ã –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ü–∏–∫–ª–∞
- [ ] –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üÜò Troubleshooting

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–∞–ª—É–µ—Ç—Å—è —á—Ç–æ –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å L1
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π L1:
```sql
SELECT * FROM deposits
WHERE user_id = <user_id>
  AND level = 1
  AND status = 'confirmed'
  AND is_roi_completed = false;
```

2. –ï—Å–ª–∏ –µ—Å—Ç—å, –ø–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å ROI

### ROI –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ payment
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ `PaymentService.processUserRewardPayments`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `roi_cap_amount` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:
```sql
SELECT * FROM deposits WHERE level = 1 AND roi_cap_amount IS NULL;
```

---

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 2025-01-12
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã**: ROI Part 2
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π**: Development Team
