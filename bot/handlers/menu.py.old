"""
Menu handler.

Handles main menu navigation.
"""

from aiogram import F, Router
from aiogram.filters import StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, default_state
from aiogram.types import Message
from sqlalchemy.ext.asyncio import AsyncSession

from app.models.user import User
from app.repositories.blacklist_repository import BlacklistRepository
from app.services.transaction_service import TransactionService
from app.services.user_service import UserService
from bot.keyboards.reply import (
    deposit_keyboard,
    main_menu_reply_keyboard,
    referral_keyboard,
    settings_keyboard,
    support_keyboard,
    withdrawal_keyboard,
)
from bot.states.update_contacts import UpdateContactsStates
from bot.utils.menu_buttons import is_menu_button

router = Router()


@router.message(F.text == "üìä –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
@router.callback_query(F.data == "menu:main")
async def show_main_menu(
    event: Message | CallbackQuery,
    session: AsyncSession,
    user: User,
    is_admin: bool = False,
) -> None:
    """
    Show main menu with conditional buttons based on user status.

    Args:
        event: Message or callback query
        session: Database session
        user: Current user
        is_admin: Whether the user is an admin
    """
    from app.repositories.blacklist_repository import BlacklistRepository
    from bot.keyboards.reply import main_menu_reply_keyboard
    from bot.keyboards.inline import main_menu_keyboard
    
    # Check blacklist status
    blacklist_repo = BlacklistRepository(session)
    blacklist_entry = await blacklist_repo.get_by_telegram_id(user.telegram_id)
    
    text = (
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username or '–ê–Ω–æ–Ω–∏–º'}\n"
        f"üí∞ –ë–∞–ª–∞–Ω—Å: {user.balance} USDT\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )

    if isinstance(event, Message):
        # Use reply keyboard for messages (with conditional buttons including admin)
        reply_keyboard = main_menu_reply_keyboard(
            user=user, 
            blacklist_entry=blacklist_entry,
            is_admin=is_admin
        )
        await event.answer(text, reply_markup=reply_keyboard)
    else:
        # Use inline keyboard for callbacks
        await event.message.edit_text(
            text, reply_markup=main_menu_keyboard()
        )
        await event.answer()


@router.message(F.text == "üìä –ë–∞–ª–∞–Ω—Å")
@router.callback_query(F.data == "menu:balance")
async def show_balance(
    event: Message | CallbackQuery,
    session: AsyncSession,
    user: User,
    state: FSMContext,
) -> None:
    """
    Show user balance.

    Args:
        event: Message or callback query
        session: Database session
        user: Current user
        state: FSM state
    """
    # Clear any active FSM state when navigating to balance
    await state.clear()
    
    user_service = UserService(session)
    balance = await user_service.get_user_balance(user.id)

    if not balance:
        if isinstance(event, Message):
            await event.answer("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞")
        else:
            await event.answer("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞", show_alert=True)
        return

    text = (
        f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å:\n\n"
        f"–û–±—â–∏–π: {balance['total_balance']:.2f} USDT\n"
        f"–î–æ—Å—Ç—É–ø–Ω–æ: {balance['available_balance']:.2f} USDT\n"
        f"–í –æ–∂–∏–¥–∞–Ω–∏–∏: {balance['pending_earnings']:.2f} USDT\n\n"
        f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
        f"–î–µ–ø–æ–∑–∏—Ç—ã: {balance['total_deposits']:.2f} USDT\n"
        f"–í—ã–≤–æ–¥—ã: {balance['total_withdrawals']:.2f} USDT\n"
        f"–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: {balance['total_earnings']:.2f} USDT"
    )

    if isinstance(event, Message):
        from bot.keyboards.reply import main_menu_reply_keyboard
        await event.answer(text, reply_markup=main_menu_reply_keyboard())
    else:
        await event.message.edit_text(
            text, reply_markup=main_menu_keyboard()
        )
        await event.answer()


@router.message(F.text == "üìú –ò—Å—Ç–æ—Ä–∏—è")
@router.callback_query(F.data == "menu:history")
async def show_history(
    event: Message | CallbackQuery,
    session: AsyncSession,
    user: User,
    state: FSMContext,
) -> None:
    """
    Show transaction history.

    Args:
        event: Message or callback query
        session: Database session
        user: Current user
        state: FSM state
    """
    # Clear any active FSM state when navigating to history
    await state.clear()
    
    tx_service = TransactionService(session)
    recent = await tx_service.get_recent_transactions(user.id, limit=10)

    if not recent:
        text = "üìú –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—É—Å—Ç–∞"
    else:
        text = "üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:\n\n"
        for tx in recent:
            status_emoji = {
                "PENDING": "‚è≥",
                "CONFIRMED": "‚úÖ",
                "FAILED": "‚ùå",
            }.get(tx.status.name, "‚ùì")

            text += (
                f"{status_emoji} {tx.description}\n"
                f"üí∞ {tx.amount} USDT\n"
                f"üìÖ {tx.created_at.strftime('%d.%m.%Y %H:%M')}\n\n"
            )

    if isinstance(event, Message):
        from bot.keyboards.reply import main_menu_reply_keyboard
        await event.answer(text, reply_markup=main_menu_reply_keyboard())
    else:
        await event.message.edit_text(
            text, reply_markup=main_menu_keyboard()
        )
        await event.answer()


@router.message(F.text == "üí∞ –î–µ–ø–æ–∑–∏—Ç")
@router.callback_query(F.data == "menu:deposit")
async def show_deposit_menu(
    event: Message | CallbackQuery,
    state: FSMContext,
) -> None:
    """
    Show deposit menu.

    Args:
        event: Message or callback query
        state: FSM state
    """
    # Clear any active FSM state when navigating to deposit
    await state.clear()
    
    text = (
        "üí∞ –î–µ–ø–æ–∑–∏—Ç\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –¥–µ–ø–æ–∑–∏—Ç–∞:\n\n"
        "üì¶ –£—Ä–æ–≤–µ–Ω—å 1: ROI cap 500%\n"
        "üì¶ –£—Ä–æ–≤–µ–Ω—å 2-5: –ë–µ–∑ ROI cap"
    )

    if isinstance(event, Message):
        from bot.keyboards.reply import main_menu_reply_keyboard
        await event.answer(
            text,
            reply_markup=main_menu_reply_keyboard(),
            parse_mode="Markdown"
        )
        await event.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å:",
            reply_markup=deposit_keyboard()
        )
    else:
        await event.message.edit_text(
            text,
            reply_markup=deposit_keyboard(),
            parse_mode="Markdown"
        )
        await event.answer()


@router.message(F.text == "üí∏ –í—ã–≤–æ–¥")
@router.callback_query(F.data == "menu:withdrawal")
async def show_withdrawal_menu(
    event: Message | CallbackQuery,
    state: FSMContext,
) -> None:
    """
    Show withdrawal menu.

    Args:
        event: Message or callback query
        state: FSM state
    """
    # Clear any active FSM state when navigating to withdrawal
    await state.clear()
    
    text = (
        "üí∏ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤\n\n"
        "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 5 USDT\n"
        "–ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ç–∏: ~0.1-0.5 USDT\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )

    if isinstance(event, Message):
        from bot.keyboards.reply import main_menu_reply_keyboard
        await event.answer(text, reply_markup=main_menu_reply_keyboard())
        await event.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=withdrawal_keyboard()
        )
    else:
        await event.message.edit_text(
            text, reply_markup=withdrawal_keyboard()
        )
        await event.answer()


@router.message(F.text == "üë• –†–µ—Ñ–µ—Ä–∞–ª—ã")
@router.callback_query(F.data == "menu:referral")
async def show_referral_menu(
    event: Message | CallbackQuery,
    user: User,
    state: FSMContext,
) -> None:
    """
    Show referral menu.

    Args:
        event: Message or callback query
        user: Current user
        state: FSM state
    """
    # Clear any active FSM state when navigating to referral
    await state.clear()
    
    # Generate referral link
    bot_username = (await event.bot.get_me()).username
    ref_link = f"https://t.me/{bot_username}?start=ref{user.telegram_id}"

    text = (
        f"üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞\n\n"
        f"–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n"
        f"`{ref_link}`\n\n"
        f"üí∞ –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è:\n"
        f"‚Ä¢ –£—Ä–æ–≤–µ–Ω—å 1: 3%\n"
        f"‚Ä¢ –£—Ä–æ–≤–µ–Ω—å 2: 2%\n"
        f"‚Ä¢ –£—Ä–æ–≤–µ–Ω—å 3: 5%\n\n"
        f"–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ!"
    )

    if isinstance(event, Message):
        from bot.keyboards.reply import main_menu_reply_keyboard
        await event.answer(text, reply_markup=main_menu_reply_keyboard(), parse_mode="Markdown")
        await event.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=referral_keyboard(user.telegram_id)
        )
    else:
        await event.message.edit_text(
            text,
            reply_markup=referral_keyboard(user.telegram_id),
        )
        await event.answer()


@router.message(F.text == "üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞")
@router.callback_query(F.data == "menu:support")
async def show_support_menu(
    event: Message | CallbackQuery,
    state: FSMContext,
) -> None:
    """
    Show support menu.

    Args:
        event: Message or callback query
        state: FSM state
    """
    # Clear any active FSM state when navigating to support
    await state.clear()
    
    text = (
        "üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞\n\n"
        "–ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º 24/7!\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )

    if isinstance(event, Message):
        from bot.keyboards.reply import support_keyboard as support_reply_keyboard
        await event.answer(text, reply_markup=support_reply_keyboard())
    else:
        await event.message.edit_text(
            text, reply_markup=support_keyboard()
        )
        await event.answer()


@router.message(F.text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
@router.callback_query(F.data == "menu:settings")
async def show_settings_menu(
    event: Message | CallbackQuery,
    session: AsyncSession,
    user: User,
    state: FSMContext,
) -> None:
    """
    Show user settings menu.

    Args:
        event: Message or callback query
        session: Database session
        user: Current user
        state: FSM state
    """
    # Clear any active FSM state when navigating to settings
    await state.clear()
    
    from bot.keyboards.inline import settings_keyboard
    from bot.keyboards.reply import main_menu_reply_keyboard
    
    # Format wallet address for display
    wallet_display = user.wallet_address
    if len(user.wallet_address) > 20:
        wallet_display = f"{user.wallet_address[:10]}...{user.wallet_address[-8:]}"
    
    text = (
        "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username or '–ê–Ω–æ–Ω–∏–º'}\n"
        f"üÜî ID: {user.id}\n"
        f"üí≥ –ö–æ—à–µ–ª–µ–∫: `{wallet_display}`\n"
        f"‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è: {'–ü—Ä–æ–π–¥–µ–Ω–∞' if user.is_verified else '–ù–µ –ø—Ä–æ–π–¥–µ–Ω–∞'}\n"
        f"üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {user.created_at.strftime('%d.%m.%Y')}\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )

    if isinstance(event, Message):
        await event.answer(
            text,
            reply_markup=main_menu_reply_keyboard(),
            parse_mode="Markdown"
        )
        # Send inline keyboard for settings actions
        await event.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É:",
            reply_markup=settings_keyboard()
        )
    else:
        await event.message.edit_text(
            text,
            reply_markup=settings_keyboard(),
            parse_mode="Markdown"
        )
        await event.answer()


@router.message(F.text == "üéÅ –ù–∞–≥—Ä–∞–¥—ã")
@router.callback_query(F.data == "menu:rewards")
async def show_rewards_menu(
    event: Message | CallbackQuery,
    session: AsyncSession,
    user: User,
    state: FSMContext,
) -> None:
    """
    Show rewards menu.

    Args:
        event: Message or callback query
        session: Database session
        user: Current user
        state: FSM state
    """
    # Clear any active FSM state when navigating to rewards
    await state.clear()
    
    from app.repositories.deposit_reward_repository import DepositRewardRepository
    
    reward_repo = DepositRewardRepository(session)
    # Get user's deposit rewards
    from sqlalchemy import select
    from app.models.deposit_reward import DepositReward
    from app.models.deposit import Deposit
    
    stmt = (
        select(DepositReward)
        .join(Deposit, DepositReward.deposit_id == Deposit.id)
        .where(Deposit.user_id == user.id)
        .order_by(DepositReward.created_at.desc())
        .limit(10)
    )
    result = await session.execute(stmt)
    rewards = result.scalars().all()
    
    if not rewards:
        text = (
            "üéÅ –ù–∞–≥—Ä–∞–¥—ã\n\n"
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞–≥—Ä–∞–¥.\n\n"
            "–ù–∞–≥—Ä–∞–¥—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞:\n"
            "‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ\n"
            "‚Ä¢ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤\n"
            "‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–æ–≤\n\n"
            "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã!"
        )
    else:
        text = "üéÅ –í–∞—à–∏ –Ω–∞–≥—Ä–∞–¥—ã:\n\n"
        total_earned = 0
        for reward in rewards:
            status_emoji = "‚úÖ" if reward.paid else "‚è≥"
            reward_amount = float(reward.reward_amount)
            text += (
                f"{status_emoji} –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –¥–µ–ø–æ–∑–∏—Ç #{reward.deposit_id}\n"
                f"üí∞ {reward_amount:.2f} USDT\n"
                f"üìÖ {reward.calculated_at.strftime('%d.%m.%Y %H:%M')}\n\n"
            )
            if reward.paid:
                total_earned += reward_amount
        
        text += f"üí∞ –í—Å–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–æ: {total_earned:.2f} USDT"
    
    if isinstance(event, Message):
        from bot.keyboards.reply import main_menu_reply_keyboard
        await event.answer(text, reply_markup=main_menu_reply_keyboard())
    else:
        await event.message.edit_text(
            text, reply_markup=main_menu_keyboard()
        )
        await event.answer()


@router.callback_query(F.data == "settings:profile")
async def show_profile_settings(
    callback: CallbackQuery,
    session: AsyncSession,
    user: User,
) -> None:
    """
    Show profile settings.

    Args:
        callback: Callback query
        session: Database session
        user: Current user
    """
    from bot.keyboards.inline import settings_keyboard
    
    text = (
        "üë§ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è\n\n"
        f"üÜî ID: {user.id}\n"
        f"üë§ Username: {user.username or '–ù–µ —É–∫–∞–∑–∞–Ω'}\n"
        f"üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {user.created_at.strftime('%d.%m.%Y %H:%M')}\n"
        f"‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è: {'–ü—Ä–æ–π–¥–µ–Ω–∞' if user.is_verified else '–ù–µ –ø—Ä–æ–π–¥–µ–Ω–∞'}\n"
        f"üö´ –°—Ç–∞—Ç—É—Å: {'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' if user.is_banned else '–ê–∫—Ç–∏–≤–µ–Ω'}\n\n"
        "–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    )
    
    await callback.message.edit_text(
        text,
        reply_markup=settings_keyboard()
    )
    await callback.answer()


@router.callback_query(F.data == "settings:wallet")
async def show_wallet_settings(
    callback: CallbackQuery,
    session: AsyncSession,
    user: User,
) -> None:
    """
    Show wallet settings.

    Args:
        callback: Callback query
        session: Database session
        user: Current user
    """
    from bot.keyboards.inline import settings_keyboard
    
    wallet_display = user.wallet_address
    if len(user.wallet_address) > 20:
        wallet_display = f"{user.wallet_address[:10]}...{user.wallet_address[-8:]}"
    
    text = (
        "üí≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—à–µ–ª—å–∫–∞\n\n"
        f"üìç –ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞:\n`{user.wallet_address}`\n\n"
        f"–û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –∞–¥—Ä–µ—Å: {wallet_display}\n\n"
        "‚ö†Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –∫–æ—à–µ–ª—å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    )
    
    await callback.message.edit_text(
        text,
        reply_markup=settings_keyboard(),
        parse_mode="Markdown"
    )
    await callback.answer()


@router.callback_query(F.data == "settings:notifications")
async def show_notification_settings(
    callback: CallbackQuery,
    session: AsyncSession,
    user: User,
) -> None:
    """
    Show notification settings.

    Args:
        callback: Callback query
        session: Database session
        user: Current user
    """
    text = (
        "üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\n\n"
        "–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ:\n"
        "‚úÖ –ù–æ–≤—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–∞—Ö\n"
        "‚úÖ –í—ã–ø–ª–∞—Ç–∞—Ö\n"
        "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è—Ö –±–∞–ª–∞–Ω—Å–∞\n"
        "‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥–∞—Ö\n\n"
        "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n"
        "–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    )
    
    await callback.message.edit_text(
        text,
        reply_markup=settings_keyboard()
    )
    await callback.answer()


@router.callback_query(F.data == "settings:update_contacts")
async def start_update_contacts(
    callback: CallbackQuery,
    session: AsyncSession,
    user: User,
    state: FSMContext,
) -> None:
    """
    Start contacts update flow.

    Args:
        callback: Callback query
        session: Database session
        user: Current user
        state: FSM state
    """
    current_contacts = []
    if user.phone:
        current_contacts.append(f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {user.phone}")
    if user.email:
        current_contacts.append(f"üìß Email: {user.email}")
    
    text = (
        "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤\n\n"
    )
    
    if current_contacts:
        text += "–¢–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã:\n" + "\n".join(current_contacts) + "\n\n"
    else:
        text += "–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã.\n\n"
    
    text += "üìû –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∏–ª–∏ /skip —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):"
    
    await callback.message.edit_text(text)
    await callback.answer()
    await state.set_state(UpdateContactsStates.waiting_for_phone)


@router.message(UpdateContactsStates.waiting_for_phone)
async def process_update_phone(
    message: Message,
    session: AsyncSession,
    user: User,
    state: FSMContext,
) -> None:
    """Process phone number update."""
    from bot.keyboards.reply import main_menu_reply_keyboard
    
    # Check if message is a menu button
    from bot.utils.menu_buttons import is_menu_button
    if is_menu_button(message.text):
        await state.clear()
        return
    
    if message.text and message.text.strip().lower() in ["/skip", "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å", "skip"]:
        await state.update_data(phone=None)
    else:
        phone = message.text.strip() if message.text else ""
        
        # Basic phone validation
        if phone and len(phone) < 5:
            await message.answer(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞!\n\n"
                "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ /skip —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å:"
            )
            return
        
        await state.update_data(phone=phone if phone else None)
    
    await state.set_state(UpdateContactsStates.waiting_for_email)
    await message.answer(
        "üìß –í–≤–µ–¥–∏—Ç–µ email (–∏–ª–∏ /skip —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):",
    )


@router.message(UpdateContactsStates.waiting_for_email)
async def process_update_email(
    message: Message,
    session: AsyncSession,
    user: User,
    state: FSMContext,
) -> None:
    """Process email update and save contacts."""
    from bot.keyboards.reply import main_menu_reply_keyboard
    
    # Check if message is a menu button
    from bot.utils.menu_buttons import is_menu_button
    if is_menu_button(message.text):
        await state.clear()
        return
    
    if message.text and message.text.strip().lower() in ["/skip", "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å", "skip"]:
        email = None
    else:
        email = message.text.strip() if message.text else None
        
        # Basic email validation
        if email and ("@" not in email or "." not in email):
            await message.answer(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email!\n\n"
                "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∏–ª–∏ /skip —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å:"
            )
            return
    
    # Get phone from state
    data = await state.get_data()
    phone = data.get("phone")
    
    # Update user with contacts
    user_service = UserService(session)
    await user_service.update_profile(
        user.id,
        phone=phone,
        email=email,
    )
    
    contacts_text = "‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã!\n\n"
    if phone:
        contacts_text += f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n"
    else:
        contacts_text += "üìû –¢–µ–ª–µ—Ñ–æ–Ω: –Ω–µ —É–∫–∞–∑–∞–Ω\n"
    
    if email:
        contacts_text += f"üìß Email: {email}\n"
    else:
        contacts_text += "üìß Email: –Ω–µ —É–∫–∞–∑–∞–Ω\n"
    
    contacts_text += "\n–í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏—Ö —Å–Ω–æ–≤–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è."
    
    await message.answer(contacts_text, reply_markup=main_menu_reply_keyboard())
    await state.clear()
