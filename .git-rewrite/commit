tree 10564442d7fefbe62d11217cc1de5b027be00175
parent ce437b8609abf0d76071af8ce2c6ea443656fbbe
author Claude <noreply@anthropic.com> 1762792661 +0000
committer Claude <noreply@anthropic.com> 1762792661 +0000
gpgsig -----BEGIN SSH SIGNATURE-----
 U1NIU0lHAAAAAQAAADMAAAALc3NoLWVkMjU1MTkAAAAgrLzsfFISF4by8Q+FKz27YpkK1USsBB+m
 amu1QkJnbDsAAAADZ2l0AAAAAAAAAAZzaGE1MTIAAABTAAAAC3NzaC1lZDI1NTE5AAAAQKZS8iff
 mAgKYdI9H4FPvU/7z4Bi889vO5RwXci99Sf7NF9+XP/Awha5CnjUtXY378QJgsoJDa0LQd2F/QhC
 UAk=
 -----END SSH SIGNATURE-----

Fix race condition in deposit matching with database locks (CRITICAL priority)

Implemented pessimistic locking to prevent race conditions when multiple blockchain transactions arrive simultaneously for the same deposit level.

Problem:
- Two concurrent blockchain events could both find the same pending deposit
- Both would update it with different tx_hash values
- Second update would overwrite the first, causing data inconsistency

Solution:
- Wrapped deposit matching in database transaction with pessimistic_write lock
- Uses SELECT FOR UPDATE to lock the deposit row during processing
- Only one concurrent transaction can claim a pending deposit
- Added explicit check for null/empty tx_hash in WHERE clause
- All operations (find, update deposit, create transaction record) are atomic

Technical details:
- Uses TypeORM's setLock('pessimistic_write') for row-level locking
- Prevents lost updates in high-concurrency scenarios
- Ensures data integrity for deposit-to-transaction matching
